<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Example</title>

    <script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>


    <link href="https://fonts.googleapis.com/css?family=Lora:400,400italic" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="../public/css/index2.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    
</head>

<body>
    <h1 class="heading"> Exercise 3 </h1>
    <div class="main-body">
        <p>You have been given <b>100k $</b>. Can you allocate it to the companies given below based on what percentage of this money you would invest in each company? </p>
        <div id="chartContainer" style="height: 300px; width: 100%;"></div>
        <div id="buttons">
        </div>
    </div>

<script type="text/javascript">
        window.onload = () => {
            CanvasJS.addColorSet("pieChartTheme", [
                "#EC5657",
                "#1BCDD1",
                "#8FAABB",
                "#B08BEB",
                "#3EA0DD",
                "#F5A52A",
                "#fff",
                "#FAA586",
                "#EB8CC6",
            ])

            let data = [
                // { y: 0, indexLabel: "PlayStation 3" },
            ]
            let addDataCount = 0;
            function addData(value, label) {
                addDataCount++;
                data.push({ y: value, indexLabel: label })
            }

            addData(0, "Coinbase")
            addData(0, "Heska")
            addData(0, "Microsoft")
            addData(0, "Gap")
            addData(0, "Coca Cola")
            addData(0, "Don't Invest")

            function getSum() {
                // console.log(data)

                let sum = 0;
                for (let i = 0; i < addDataCount; i++) {
                    sum += data[i].y;
                }
                return sum;
            }

            function renderChart() {
                let sum = getSum();
                console.log(`sum: ${sum}`)
                let additionalData = false;

                if (sum < 100) {
                    additionalData = true;
                }

                var chart = new CanvasJS.Chart("chartContainer",
                    {
                        colorSet: 'pieChartTheme',
                        title: {
                            text: "Portfolio Allocation"
                        },
                        legend: {
                            maxWidth: 350,
                            itemWidth: 120
                        },
                        data: [
                            {
                                type: "pie",
                                showInLegend: true,
                                legendText: "{indexLabel}",
                                dataPoints: additionalData ? [...data, { y: 100 - sum, indexLabel: '' }] : data
                            }
                        ],
                    });
                chart.render();
            }

            let oldData = [];
            for (let i = 0; i < addDataCount; i++) {
                oldData.push(0);
            }

            data.forEach((dataPoint, index) => {
                let mySpan = document.createElement("span");
                let inputBox = document.createElement("input");
                let label = document.createElement("label")

                inputBox.type = "range"
                inputBox.id = `input${index}`
                inputBox.min = 0
                inputBox.max = 100
                inputBox.value = data[index].y

                label.for = "input" + index
                label.innerText = data[index].indexLabel

                inputBox.oninput = function (event) {

                    let sum = getSum();
                    let newValue = parseInt(event.target.value);
                    console.log(newValue)
                    if (sum >= 100) {

                        if (newValue < oldData[index]) {
                            oldData[index] = data[index].y;
                            data[index].y = newValue;
                            renderChart();
                            return;
                        }
                        alert('sum is already 100')
                        inputBox.value = oldData[index];

                        return
                    }
                    if (newValue <= 100) {
                        oldData[index] = data[index].y;
                        data[index].y = newValue;

                    }
                    else {
                        inputBox.value = oldData[index];
                    }

                    renderChart();
                }
                mySpan.append(inputBox);
                // document.getElementById("buttons").append(inputBox, document.createElement("br"), label)
                document.getElementById("buttons").append(label, mySpan, document.createElement("br"))
                renderChart();
            })
        };
    </script>

</body>

</html>